
<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>Week 4 Lab Storage Management</title>

<script src="https://cdn.tailwindcss.com?plugins=typography"></script>
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
<script>
    tailwind.config = {
        darkMode: 'class',
        theme: {
            extend: {
                fontFamily: {
                    sans: ['Inter', 'sans-serif'],
                },
                colors: {
                    primary: '#002F6E', // VUT Midnight Blue
                    secondary: '#6c757d',
                    codebg: 'var(--bg-code)', 
                },
                typography: {
                    DEFAULT: {
                        css: {
                            maxWidth: '100%',
                            fontFamily: 'Inter, sans-serif',
                            color: 'var(--text-body)',
                            '--tw-prose-body': 'var(--text-body)',
                            '--tw-prose-headings': 'var(--text-headings)',
                            '--tw-prose-links': 'var(--text-link)',
                            '--tw-prose-bold': 'var(--text-headings)',
                            '--tw-prose-counters': 'var(--text-body)',
                            '--tw-prose-bullets': 'var(--text-body)',
                            '--tw-prose-hr': 'var(--border-color)',
                            '--tw-prose-quotes': 'var(--text-body)',
                            '--tw-prose-code': 'var(--text-code)',
                            '--tw-prose-pre-code': 'var(--text-pre)',
                            '--tw-prose-pre-bg': 'var(--bg-pre)',
                            
                            // Image Sizing Control
                            img: {
                                display: 'block',
                                marginLeft: 'auto',
                                marginRight: 'auto',
                                maxHeight: '500px',
                                width: 'auto',
                                height: 'auto',
                                borderRadius: '0.5rem',
                                boxShadow: '0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06)',
                            },
                            // Links
                            a: {
                                color: 'var(--text-link)',
                                '&:hover': { opacity: '0.8' },
                            },
                            // Inline Code
                            code: {
                                color: 'var(--text-code)',
                                backgroundColor: 'var(--bg-code)',
                                padding: '0.2rem 0.4rem',
                                borderRadius: '0.25rem',
                                fontWeight: '600',
                                border: '1px solid var(--border-code)',
                            },
                            'code::before': { content: '""' },
                            'code::after': { content: '""' },
                            // Code Blocks (Pre)
                            pre: {
                                backgroundColor: 'var(--bg-pre) !important',
                                color: 'var(--text-pre)',
                                padding: '1rem',
                                borderRadius: '0.5rem',
                                border: '1px solid var(--border-pre)',
                            },
                            // Notes/Alerts (Blockquotes)
                            blockquote: {
                                borderLeftColor: '#002F6E',
                                borderLeftWidth: '4px',
                                backgroundColor: 'var(--bg-note)',
                                padding: '1rem',
                                color: 'var(--text-body)',
                                fontSize: '0.9rem', // Smaller text for notes
                                fontStyle: 'italic',
                                quotes: 'none',
                                borderRadius: '0 0.5rem 0.5rem 0',
                            },
                            'blockquote p:first-of-type::before': { content: 'none' },
                            'blockquote p:last-of-type::after': { content: 'none' },
                            // Tables (Restored from First Attempt)
                            table: {
                                width: '100%',
                                marginTop: '2em',
                                marginBottom: '2em',
                                borderCollapse: 'collapse',
                                fontSize: '0.9rem',
                            },
                            'thead th': {
                                backgroundColor: '#f3f4f6', 
                                color: '#1f2937', 
                                fontWeight: '600',
                                padding: '0.75rem',
                                borderBottom: '2px solid #e5e7eb',
                                textAlign: 'left',
                            },
                            'tbody td': {
                                padding: '0.75rem',
                                borderBottom: '1px solid #e5e7eb',
                                verticalAlign: 'top',
                            },
                            'tbody tr:hover': {
                                backgroundColor: '#f9fafb',
                            },
                            
                            // Task Lists (Checkboxes)
                            '.task-list-item': {
                                listStyleType: 'none',
                            },
                            '.task-list-item input[type="checkbox"]': {
                                marginRight: '0.5rem',
                            },

                            thead: {
                                borderBottomWidth: '2px',
                                borderBottomColor: 'var(--border-color)',
                            },
                            'thead th': {
                                color: 'var(--text-headings)',
                                fontWeight: '600',
                                verticalAlign: 'bottom',
                                paddingRight: '0.75em',
                                paddingBottom: '0.75em',
                                paddingLeft: '0.75em',
                                textAlign: 'left',
                            },
                            'tbody tr': {
                                borderBottomWidth: '1px',
                                borderBottomColor: 'var(--border-color)',
                            },
                            'tbody tr:last-child': {
                                borderBottomWidth: '0',
                            },
                            'tbody td': {
                                verticalAlign: 'top',
                                padding: '0.75em',
                            },
                        },
                    },
                },
            },
        },
    }
</script>
<script>
    // Theme Toggle Logic
    document.addEventListener('DOMContentLoaded', () => {
        const themeToggle = document.getElementById('theme-toggle');
        const html = document.documentElement;
        const iconSun = document.getElementById('icon-sun');
        const iconMoon = document.getElementById('icon-moon');

        // Check local storage or preference
        if (localStorage.theme === 'dark' || (!('theme' in localStorage) && window.matchMedia('(prefers-color-scheme: dark)').matches)) {
            html.classList.add('dark');
            iconSun.classList.remove('hidden');
            iconMoon.classList.add('hidden');
        } else {
            html.classList.remove('dark');
            iconSun.classList.add('hidden');
            iconMoon.classList.remove('hidden');
        }

        themeToggle.addEventListener('click', () => {
            if (html.classList.contains('dark')) {
                html.classList.remove('dark');
                localStorage.theme = 'light';
                iconSun.classList.add('hidden');
                iconMoon.classList.remove('hidden');
            } else {
                html.classList.add('dark');
                localStorage.theme = 'dark';
                iconSun.classList.remove('hidden');
                iconMoon.classList.add('hidden');
            }
        });
    });
</script>
<style>
    /* CSS Variables for Theming */
    :root {
        --bg-body: #f8fafc;
        --bg-card: #ffffff;
        --text-body: #334155;
        --text-headings: #0f172a;
        --text-link: #002F6E; /* VUT Blue */
        --border-color: #e2e8f0;
        
        /* Code - Light Mode */
        --bg-code: #f1f5f9;
        --text-code: #d63384;
        --border-code: #e2e8f0;
        
        /* Pre - Light Mode (Github Light) */
        --bg-pre: #f6f8fa;
        --text-pre: #24292e;
        --border-pre: #d0d7de;
        
        /* Note - Light Mode */
        --bg-note: #f8f9fa;
        
        /* Scrollbar */
        --scroll-track: #f1f1f1;
        --scroll-thumb: #888;
    }

    html.dark {
        --bg-body: #0f172a;
        --bg-card: #1e293b;
        --text-body: #cbd5e1;
        --text-headings: #f8fafc;
        --text-link: #60a5fa; /* Blue 400 - Brighter for better contrast */
        --border-color: #334155;
        
        /* Code - Dark Mode */
        --bg-code: #334155;
        --text-code: #f472b6; 
        --border-code: #475569;
        
        /* Pre - Dark Mode (Monokai) */
        --bg-pre: #272822;
        --text-pre: #f8f8f2;
        --border-pre: #464539;
        
        /* Note - Dark Mode */
        --bg-note: #1e293b;
        --scroll-track: #1e293b;
        --scroll-thumb: #475569;
    }

    /* Transition */
    body, article, code, pre, blockquote {
        transition: background-color 0.3s, color 0.3s, border-color 0.3s;
    }

    /* Custom Scrollbar */
    ::-webkit-scrollbar { width: 8px; height: 8px; }
    ::-webkit-scrollbar-track { background: var(--scroll-track); }
    ::-webkit-scrollbar-thumb { background: var(--scroll-thumb); border-radius: 4px; }
    ::-webkit-scrollbar-thumb:hover { background: #555; }
    
    /* Syntax Highlighting - LIGHT MODE (GitHub Light Inspired) */
    .codehilite .hll { background-color: #ffffcc }
    .codehilite .c { color: #6a737d; font-style: italic } /* Comment */
    .codehilite .err { color: #f05240; background-color: #ffeaea } /* Error */
    .codehilite .k { color: #d73a49; font-weight: bold } /* Keyword */
    .codehilite .o { color: #d73a49; font-weight: bold } /* Operator */
    .codehilite .cm { color: #6a737d; font-style: italic } /* Comment.Multiline */
    .codehilite .cp { color: #6a737d; font-weight: bold } /* Comment.Preproc */
    .codehilite .c1 { color: #6a737d; font-style: italic } /* Comment.Single */
    .codehilite .cs { color: #6a737d; font-style: italic } /* Comment.Special */
    .codehilite .gd { color: #d73a49; background-color: #fdd } /* Generic.Deleted */
    .codehilite .ge { font-style: italic } /* Generic.Emph */
    .codehilite .gr { color: #aa0000 } /* Generic.Error */
    .codehilite .gh { color: #000080; font-weight: bold } /* Generic.Heading */
    .codehilite .gi { color: #00a000; background-color: #dfd } /* Generic.Inserted */
    .codehilite .go { color: #888888 } /* Generic.Output */
    .codehilite .gp { color: #c65d09; font-weight: bold } /* Generic.Prompt */
    .codehilite .gs { font-weight: bold } /* Generic.Strong */
    .codehilite .gu { color: #800080; font-weight: bold } /* Generic.Subheading */
    .codehilite .gt { color: #aa0000 } /* Generic.Traceback */
    .codehilite .kc { color: #005cc5; font-weight: bold } /* Keyword.Constant */
    .codehilite .kd { color: #d73a49; font-weight: bold } /* Keyword.Declaration */
    .codehilite .kn { color: #d73a49; font-weight: bold } /* Keyword.Namespace */
    .codehilite .kp { color: #d73a49 } /* Keyword.Pseudo */
    .codehilite .kr { color: #d73a49; font-weight: bold } /* Keyword.Reserved */
    .codehilite .kt { color: #445588; font-weight: bold } /* Keyword.Type */
    .codehilite .m { color: #005cc5 } /* Literal.Number */
    .codehilite .s { color: #032f62 } /* Literal.String */
    .codehilite .na { color: #22863a } /* Name.Attribute */
    .codehilite .nb { color: #005cc5 } /* Name.Builtin */
    .codehilite .nc { color: #6f42c1; font-weight: bold } /* Name.Class */
    .codehilite .no { color: #005cc5 } /* Name.Constant */
    .codehilite .nd { color: #6f42c1; font-weight: bold } /* Name.Decorator */
    .codehilite .ni { color: #800080 } /* Name.Entity */
    .codehilite .ne { color: #990000; font-weight: bold } /* Name.Exception */
    .codehilite .nf { color: #6f42c1; font-weight: bold } /* Name.Function */
    .codehilite .nl { color: #990000; font-weight: bold } /* Name.Label */
    .codehilite .nn { color: #6f42c1; font-weight: bold } /* Name.Namespace */
    .codehilite .nt { color: #22863a } /* Name.Tag */
    .codehilite .nv { color: #e36209 } /* Name.Variable */
    .codehilite .ow { color: #d73a49; font-weight: bold } /* Operator.Word */
    .codehilite .w { color: #bbbbbb } /* Text.Whitespace */
    .codehilite .mf { color: #005cc5 } /* Literal.Number.Float */
    .codehilite .mh { color: #005cc5 } /* Literal.Number.Hex */
    .codehilite .mi { color: #005cc5 } /* Literal.Number.Integer */
    .codehilite .mo { color: #005cc5 } /* Literal.Number.Oct */
    .codehilite .sb { color: #032f62 } /* Literal.String.Backtick */
    .codehilite .sc { color: #032f62 } /* Literal.String.Char */
    .codehilite .sd { color: #032f62 } /* Literal.String.Doc */
    .codehilite .s2 { color: #032f62 } /* Literal.String.Double */
    .codehilite .se { color: #005cc5 } /* Literal.String.Escape */
    .codehilite .sh { color: #032f62 } /* Literal.String.Heredoc */
    .codehilite .si { color: #032f62 } /* Literal.String.Interpol */
    .codehilite .sx { color: #032f62 } /* Literal.String.Other */
    .codehilite .sr { color: #032f62 } /* Literal.String.Regex */
    .codehilite .s1 { color: #032f62 } /* Literal.String.Single */
    .codehilite .ss { color: #005cc5 } /* Literal.String.Symbol */
    .codehilite .bp { color: #005cc5 } /* Name.Builtin.Pseudo */
    .codehilite .vc { color: #e36209 } /* Name.Variable.Class */
    .codehilite .vg { color: #e36209 } /* Name.Variable.Global */
    .codehilite .vi { color: #e36209 } /* Name.Variable.Instance */
    .codehilite .il { color: #005cc5 } /* Literal.Number.Integer.Long */
    
    /* Syntax Highlighting - DARK MODE (Monokai Overrides) */
    html.dark .codehilite .hll { background-color: #49483e }
    html.dark .codehilite .c { color: #75715e } /* Comment */
    html.dark .codehilite .err { color: #960050; background-color: #1e0010 } /* Error */
    html.dark .codehilite .k { color: #66d9ef; font-weight: normal } /* Keyword */
    html.dark .codehilite .l { color: #ae81ff } /* Literal */
    html.dark .codehilite .n { color: #f8f8f2 } /* Name */
    html.dark .codehilite .o { color: #f92672; font-weight: normal } /* Operator */
    html.dark .codehilite .p { color: #f8f8f2 } /* Punctuation */
    html.dark .codehilite .cm { color: #75715e } /* Comment.Multiline */
    html.dark .codehilite .cp { color: #75715e } /* Comment.Preproc */
    html.dark .codehilite .c1 { color: #75715e } /* Comment.Single */
    html.dark .codehilite .cs { color: #75715e } /* Comment.Special */
    html.dark .codehilite .ge { font-style: italic } /* Generic.Emph */
    html.dark .codehilite .gs { font-weight: bold } /* Generic.Strong */
    html.dark .codehilite .kc { color: #66d9ef; font-weight: normal } /* Keyword.Constant */
    html.dark .codehilite .kd { color: #66d9ef; font-weight: normal  } /* Keyword.Declaration */
    html.dark .codehilite .kn { color: #f92672; font-weight: normal  } /* Keyword.Namespace */
    html.dark .codehilite .kp { color: #66d9ef; font-weight: normal  } /* Keyword.Pseudo */
    html.dark .codehilite .kr { color: #66d9ef; font-weight: normal  } /* Keyword.Reserved */
    html.dark .codehilite .kt { color: #66d9ef; font-weight: normal  } /* Keyword.Type */
    html.dark .codehilite .ld { color: #e6db74 } /* Literal.Date */
    html.dark .codehilite .m { color: #ae81ff } /* Literal.Number */
    html.dark .codehilite .s { color: #e6db74 } /* Literal.String */
    html.dark .codehilite .na { color: #a6e22e } /* Name.Attribute */
    html.dark .codehilite .nb { color: #f8f8f2 } /* Name.Builtin */
    html.dark .codehilite .nc { color: #a6e22e } /* Name.Class */
    html.dark .codehilite .no { color: #66d9ef } /* Name.Constant */
    html.dark .codehilite .nd { color: #a6e22e } /* Name.Decorator */
    html.dark .codehilite .ni { color: #f8f8f2 } /* Name.Entity */
    html.dark .codehilite .ne { color: #a6e22e } /* Name.Exception */
    html.dark .codehilite .nf { color: #a6e22e } /* Name.Function */
    html.dark .codehilite .nl { color: #f8f8f2 } /* Name.Label */
    html.dark .codehilite .nn { color: #f8f8f2 } /* Name.Namespace */
    html.dark .codehilite .nx { color: #a6e22e } /* Name.Other */
    html.dark .codehilite .py { color: #f8f8f2 } /* Name.Property */
    html.dark .codehilite .nt { color: #f92672 } /* Name.Tag */
    html.dark .codehilite .nv { color: #f8f8f2 } /* Name.Variable */
    html.dark .codehilite .ow { color: #f92672; font-weight: normal  } /* Operator.Word */
    html.dark .codehilite .w { color: #f8f8f2 } /* Text.Whitespace */
    html.dark .codehilite .mb { color: #ae81ff } /* Literal.Number.Bin */
    html.dark .codehilite .mf { color: #ae81ff } /* Literal.Number.Float */
    html.dark .codehilite .mh { color: #ae81ff } /* Literal.Number.Hex */
    html.dark .codehilite .mi { color: #ae81ff } /* Literal.Number.Integer */
    html.dark .codehilite .mo { color: #ae81ff } /* Literal.Number.Oct */
    html.dark .codehilite .sb { color: #e6db74 } /* Literal.String.Backtick */
    html.dark .codehilite .sc { color: #e6db74 } /* Literal.String.Char */
    html.dark .codehilite .sd { color: #e6db74 } /* Literal.String.Doc */
    html.dark .codehilite .s2 { color: #e6db74 } /* Literal.String.Double */
    html.dark .codehilite .se { color: #ae81ff } /* Literal.String.Escape */
    html.dark .codehilite .sh { color: #e6db74 } /* Literal.String.Heredoc */
    html.dark .codehilite .si { color: #e6db74 } /* Literal.String.Interpol */
    html.dark .codehilite .sx { color: #e6db74 } /* Literal.String.Other */
    html.dark .codehilite .sr { color: #e6db74 } /* Literal.String.Regex */
    html.dark .codehilite .s1 { color: #e6db74 } /* Literal.String.Single */
    html.dark .codehilite .ss { color: #ae81ff } /* Literal.String.Symbol */
</style>

</head>
<body class="bg-[var(--bg-body)] text-[var(--text-body)] pt-20 transition-colors duration-300">

<!-- Navigation -->
<nav class="fixed top-0 left-0 right-0 bg-[var(--bg-card)]/90 backdrop-blur-md shadow-sm z-50 border-b border-[var(--border-color)] transition-colors duration-300">
    <div class="container mx-auto px-4 max-w-5xl h-16 flex items-center justify-between">
        <a href="../Course_Index.html" class="flex items-center space-x-3 text-[var(--text-headings)] hover:text-blue-600 transition-colors no-underline">
            <img src="../ops3_logo.png" alt="VUT Logo" class="h-12 w-auto object-contain">
            <div class="flex flex-col">
                <span class="font-bold text-lg leading-tight tracking-tight text-primary dark:text-sky-400 hidden sm:block">Operating Systems 3</span>
                <span class="text-xs text-slate-500 dark:text-slate-400 font-medium hidden sm:block">Virtualisation & Cloud Technologies</span>
                <span class="font-bold text-lg tracking-tight sm:hidden">OPS3</span>
            </div>
        </a>
        <div class="flex items-center space-x-6">
            <a href="../Course_Index.html" class="text-sm font-medium text-slate-600 dark:text-slate-300 hover:text-blue-600 dark:hover:text-sky-400 transition-colors no-underline">
                Course Home
            </a>
            <!-- Theme Toggle Button -->
            <button id="theme-toggle" class="p-2 rounded-full hover:bg-slate-200 dark:hover:bg-slate-700 transition-colors">
                <!-- Sun Icon -->
                <svg id="icon-sun" class="w-5 h-5 text-yellow-500 hidden" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 3v1m0 16v1m9-9h-1M4 12H3m15.364 6.364l-.707-.707M6.343 6.343l-.707-.707m12.728 0l-.707.707M6.343 17.657l-.707.707M16 12a4 4 0 11-8 0 4 4 0 018 0z"></path></svg>
                <!-- Moon Icon -->
                <svg id="icon-moon" class="w-5 h-5 text-slate-500" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M20.354 15.354A9 9 0 018.646 3.646 9.003 9.003 0 0012 21a9.003 9.003 0 008.354-5.646z"></path></svg>
            </button>
        </div>
    </div>
</nav>

<!-- Main Content -->
<main class="container mx-auto px-4 max-w-5xl mb-12">
    <article class="prose lg:prose-lg max-w-none bg-[var(--bg-card)] p-6 md:p-12 rounded-xl shadow-sm border border-[var(--border-color)] transition-colors duration-300">
        <p><a href="../Course_Index.html">← Back to Course Index</a></p>
<h1 id="week-4-lab-kvm-storage-management">Week 4 - Lab: KVM Storage Management</h1>
<p><strong>Module</strong>: Operating Systems 3 (Virtualisation &amp; Cloud Technologies)  </p>
<p><strong>Topic</strong>: KVM Disk Images, LVM, Snapshots, and NFS<br />
<strong>Estimated Time</strong>: 120 Minutes</p>
<hr />
<h2 id="lab-overview">Lab Overview</h2>
<p>In this lab, you will go "under the hood" of virtualization storage. Instead of relying on the Proxmox GUI, you will work directly with the KVM storage layer. You will create raw disk images, manage them with <code>qemu-img</code>, partition them with LVM, and perform manual snapshots and backups. Finally, you will configure networked storage using NFS.</p>
<p><strong>Objectives</strong>:</p>
<ol>
<li>Create and manage Virtual Disk Images (<code>raw</code> and <code>qcow2</code>) using <code>qemu-img</code>.</li>
<li>Manage storage inside a Linux VM using Logical Volume Manager (LVM).</li>
<li>Perform internal snapshots using KVM command-line tools.</li>
<li>Execute "Cold Backups" by manipulating disk image files directly.</li>
<li>Configure Network File System (NFS) for shared storage.</li>
</ol>
<p><strong>Prerequisites</strong>:
- A running Proxmox VE host (Shell Access Required).
- A Linux VM (for LVM and NFS sections).
- Basic understanding of Linux file permissions.</p>
<hr />
<h2 id="part-1-virtual-disk-management-kvm">Part 1: Virtual Disk Management (KVM)</h2>
<p>At the lowest level, a Virtual Machine's "hard drive" is just a file on the host operating system. We will use the <code>qemu-img</code> tool to manipulate these files.</p>
<h3 id="step-1-inspecting-disk-images">Step 1: Inspecting Disk Images</h3>
<ol>
<li>
<p><strong>Open the Proxmox Shell</strong> (Datacenter &gt; Node &gt; Shell).</p>
</li>
<li>
<p><strong>Navigate to the image directory</strong>:
    <code>bash
    cd /var/lib/vz/images/
    ls -lh</code>
    <em>You might see directories for your existing VMs (e.g., <code>100</code>, <code>101</code>).</em></p>
</li>
<li>
<p><strong>Inspect an existing image</strong> (replace <code>[VMID]</code> with an actual ID):
    <code>bash
    qemu-img info [VMID]/vm-[VMID]-disk-0.qcow2</code>
    <em>(If you don't have a VM, skip to Step 2).</em></p>
</li>
<li>
<p><strong>Field Report</strong>:</p>
<ul>
<li><strong>Image Format</strong>: <code>[ qcow2 / raw ]</code></li>
<li><strong>Virtual Size</strong>: <code>[ _____________________________ ]</code></li>
<li><strong>Disk Size</strong> (actual space used): <code>[ _____________________________ ]</code></li>
</ul>
</li>
</ol>
<p><strong>Critical Thinking</strong>:</p>
<ul>
<li>Why is "disk size" often smaller than "virtual size"?</li>
<li><code>[ _________________________________________________________________________ ]</code> (Hint: Sparse files)</li>
</ul>
<h3 id="step-2-creating-new-images">Step 2: Creating New Images</h3>
<ol>
<li>
<p><strong>Create a RAW image</strong> (1GB):
    <code>bash
    qemu-img create -f raw test-disk.raw 1G</code></p>
</li>
<li>
<p><strong>Create a QCOW2 image</strong> (1GB):
    <code>bash
    qemu-img create -f qcow2 test-disk.qcow2 1G</code></p>
</li>
<li>
<p><strong>Compare sizes</strong>:
    <code>bash
    ls -lh test-disk.*</code></p>
</li>
<li>
<p><strong>Field Report</strong>:</p>
<ul>
<li><strong>RAW file size</strong>: <code>[ _____________________________ ]</code></li>
<li><strong>QCOW2 file size</strong>: <code>[ _____________________________ ]</code></li>
</ul>
</li>
</ol>
<h3 id="step-3-format-conversion-compression">Step 3: Format Conversion &amp; Compression</h3>
<p>You can convert disk formats (e.g., to save space or import from another hypervisor).</p>
<ol>
<li>
<p><strong>Convert RAW to Compressed QCOW2</strong>:
    <code>bash
    qemu-img convert -c -f raw -O qcow2 test-disk.raw test-disk-compressed.qcow2</code></p>
</li>
<li>
<p><strong>Verify details</strong>:
    <code>bash
    qemu-img info test-disk-compressed.qcow2</code></p>
</li>
<li>
<p><strong>Field Report</strong>:</p>
<ul>
<li><strong>Final size</strong>: <code>[ _____________________________ ]</code></li>
</ul>
</li>
</ol>
<h3 id="step-4-resizing-images">Step 4: Resizing Images</h3>
<ol>
<li>
<p><strong>Expand the QCOW2 image</strong>:
    <code>bash
    qemu-img resize test-disk.qcow2 +2G</code></p>
</li>
<li>
<p><strong>Verify new size</strong>:
    <code>bash
    qemu-img info test-disk.qcow2</code>
    <em>Expected: Virtual size should now be 3GB.</em></p>
</li>
</ol>
<hr />
<h2 id="part-2-managing-storage-inside-the-guest-lvm">Part 2: Managing Storage inside the Guest (LVM)</h2>
<p>Now that you understand the "physical" disk (the file on the host), let's look at how the Guest OS manages that space using Logical Volume Manager (LVM).</p>
<p><strong>Note</strong>: For this section, use your Ubuntu/Linux VM. You can use the <code>test-disk.raw</code> we created earlier by attaching it to your VM via Proxmox GUI (Hardware &gt; Add &gt; Hard Disk &gt; Import/Use existing), OR simpler: just create a dummy file inside the VM to practice LVM.</p>
<p><strong>Method: Using a loopback file inside the VM (Safe Mode)</strong></p>
<ol>
<li>
<p><strong>Log into your Linux VM</strong>.</p>
</li>
<li>
<p><strong>Create a 1GB file</strong> (simulates a hard drive):
    <code>bash
    dd if=/dev/zero of=/root/virtual_disk.img bs=1M count=1000</code></p>
</li>
<li>
<p><strong>Attach it to a loop device</strong>:
    <code>bash
    losetup /dev/loop0 /root/virtual_disk.img</code></p>
</li>
<li>
<p><strong>Initialize Physical Volume (PV)</strong>:
    <code>bash
    pvcreate /dev/loop0</code></p>
</li>
<li>
<p><strong>Create Volume Group (VG)</strong>:
    <code>bash
    vgcreate lab_vg /dev/loop0</code></p>
</li>
<li>
<p><strong>Create Logical Volume (LV)</strong> (500MB):
    <code>bash
    lvcreate -n lab_vol -L 500M lab_vg</code></p>
</li>
<li>
<p><strong>Format and Mount</strong>:
    <code>bash
    mkfs.ext4 /dev/lab_vg/lab_vol
    mkdir /mnt/test_volume
    mount /dev/lab_vg/lab_vol /mnt/test_volume</code></p>
</li>
<li>
<p><strong>Verify</strong>:
    <code>bash
    df -h /mnt/test_volume
    lvs</code></p>
</li>
<li>
<p><strong>Field Report</strong>:</p>
<ul>
<li><strong>LV Name</strong>: <code>[ _____________________________ ]</code></li>
<li><strong>Filesystem Type</strong>: <code>[ ext4 / xfs ]</code></li>
</ul>
</li>
</ol>
<hr />
<h2 id="part-3-vm-snapshots-kvm-cli">Part 3: VM Snapshots (KVM CLI)</h2>
<p>Proxmox GUI uses these same commands in the background. Let's do it manually on a QCOW2 file.</p>
<ol>
<li>
<p><strong>Back on the Proxmox Host Shell</strong>.</p>
</li>
<li>
<p><strong>Take a snapshot</strong> of your test QCOW2 image:
    <code>bash
    qemu-img snapshot -c snap1 test-disk.qcow2</code>
    <em><code>-c</code> stands for Create.</em></p>
</li>
<li>
<p><strong>List snapshots</strong>:
    <code>bash
    qemu-img snapshot -l test-disk.qcow2</code></p>
</li>
<li>
<p><strong>Field Report</strong>:</p>
<ul>
<li><strong>Snapshot ID</strong>: <code>[ _____ ]</code></li>
<li><strong>Snapshot Name</strong>: <code>[ _____ ]</code></li>
</ul>
</li>
<li>
<p><strong>Restore a snapshot</strong> (Hypothetical command):
    <em>To apply a snapshot, you would use <code>-a</code> (Apply).</em>
    <code>bash
    # qemu-img snapshot -a snap1 test-disk.qcow2</code></p>
</li>
</ol>
<p><strong>Critical Thinking</strong>:</p>
<ul>
<li>Can you take a snapshot of a <code>raw</code> format disk?</li>
<li><code>[ _________________________________________________________________________ ]</code> (Try it on <code>test-disk.raw</code> and see what happens).</li>
</ul>
<hr />
<h2 id="part-4-vm-backups-image-operations">Part 4: VM Backups (Image Operations)</h2>
<p>A "Cold Backup" is simply copying the disk image while the VM is off.</p>
<ol>
<li>
<p><strong>Ensure the VM/Disk is not in use</strong>.</p>
</li>
<li>
<p><strong>Create a backup copy</strong>:
    <code>bash
    cp test-disk.qcow2 test-disk.qcow2.backup</code></p>
</li>
<li>
<p><strong>Verify the backup</strong>:
    <code>bash
    ls -lh test-disk.qcow2*</code></p>
</li>
<li>
<p><strong>Simulate Corruption</strong>:
    <code>bash
    echo "CORRUPTION" &gt; test-disk.qcow2
    # The file is now broken.</code></p>
</li>
<li>
<p><strong>Restore from Backup</strong>:
    <code>bash
    rm test-disk.qcow2
    cp test-disk.qcow2.backup test-disk.qcow2</code></p>
</li>
<li>
<p><strong>Field Report</strong>:</p>
<ul>
<li>Why must the VM be <strong>offline</strong> for a simple <code>cp</code> backup?</li>
<li><code>[ _________________________________________________________________________ ]</code></li>
</ul>
</li>
</ol>
<hr />
<h2 id="part-5-zfs-storage-advanced">Part 5: ZFS Storage (Advanced)</h2>
<p>ZFS is the gold standard for enterprise storage. It features self-healing, instant snapshots, and RAID capabilities without needing a hardware controller. We will simulate this using file-backed storage (since we don't have extra physical disks).</p>
<h3 id="step-1-create-simulated-disks">Step 1: Create Simulated Disks</h3>
<ol>
<li><strong>Create two 1GB files</strong>:
    <code>bash
    truncate -s 1G /root/disk</p>
<ol>

</ol>
</li>
<li>
<p><strong>Verify the status</strong>:
    <code>bash
    zpool status</code>
    <em>You should see <code>pool: tank</code> and <code>state: ONLINE</code> with a mirror of disk1 and disk2.</em></p>
</li>
</ol>
<h3 id="step-3-self-healing-in-action">Step 3: Self-Healing in Action</h3>
<ol>
<li>
<p><strong>Create some crucial data</strong>:
    <code>bash
    echo "This data must survive corruption" &gt; /tank/crucial.txt
    sha256sum /tank/crucial.txt</code></p>
</li>
<li>
<p><strong>Simulate Disk Corruption</strong> (Sabotage one "disk"):
    <code>bash
    # Overwrite the beginning of disk1 with garbage
    dd if=/dev/urandom of=/root/disk1.img bs=1M count=10 conv=notrunc</code></p>
</li>
<li>
<p><strong>Attempt to read data</strong> (ZFS will detect and fix on-the-fly):
    <code>bash
    cat /tank/crucial.txt</code>
    <em>It should still read successfully! ZFS read from the good copy (disk2).</em></p>
</li>
<li>
<p><strong>Check Status and Repair</strong>:
    <code>bash
    zpool scrub tank
    zpool status</code>
    <em>You should see "checksum errors" on <code>disk1.img</code>, but "Repairing" or "Repaired".</em></p>
</li>
</ol>
<h3 id="step-4-native-snapshots">Step 4: Native Snapshots</h3>
<ol>
<li>
<p><strong>Take an instant snapshot</strong>:
    <code>bash
    zfs snapshot tank@bookmark1</code></p>
</li>
<li>
<p><strong>Delete the file</strong>:
    <code>bash
    rm /tank/crucial.txt</code></p>
</li>
<li>
<p><strong>Rollback instantly</strong>:
    <code>bash
    zfs rollback tank@bookmark1
    cat /tank/crucial.txt</code></p>
</li>
<li>
<p><strong>Field Report</strong>:</p>
<ul>
<li><strong>ZFS Pool Health</strong>: <code>[ _____________________________ ]</code></li>
<li><strong>Checksum Errors Detected</strong>: <code>[ _____________________________ ]</code></li>
<li><strong>Data Survived Corruption</strong>: <code>[ Yes / No ]</code></li>
</ul>
</li>
</ol>
<h3 id="step-5-zfs-volumes-zvols-the-vm-connection">Step 5: ZFS Volumes (Zvols) - The VM Connection</h3>
<p>So far, we used ZFS like a file system (storing text files). But Virtual Machines need <strong>Block Devices</strong> (like hard drives). ZFS provides this through <strong>Zvols</strong>.</p>
<ol>
<li>
<p><strong>Create a Zvol (Virtual Block Device)</strong>:
    <code>bash
    # Create a 500MB block device on the 'tank' pool
    zfs create -V 500M tank/vm-disk-1</code></p>
</li>
<li>
<p><strong>Verify the Device</strong>:
    <code>bash
    ls -l /dev/zvol/tank/vm-disk-1</code>
    <em>Notice it looks like a device file (brw-rw----), not a regular file.</em></p>
</li>
<li>
<p><strong>Use it (Attach to VM)</strong>:
    <em>In a real Proxmox VM, this <code>/dev/zvol/tank/vm-disk-1</code> path acts exactly like a physical hard drive. KVM writes raw blocks directly to it.</em></p>
<p><strong>Option A: Format directly on Host (Quick Test)</strong>
<code>bash
mkfs.ext4 /dev/zvol/tank/vm-disk-1</code></p>
<p><strong>Option B: Attach to your "Lab 2" VM (Manual KVM)</strong>
<em>Recall the manual KVM VM we created in Lab 2. We can attach this Zvol to it as a secondary hard drive.</em></p>
<ol>
<li><strong>Stop the VM</strong> (if it's running).</li>
<li><strong>Start it with the Zvol attached</strong>:
    <em>We simply add another <code>-drive</code> argument pointing to our Zvol block device.</em>
    <code>bash
    qemu-system-x86_64 \
      -enable-kvm \
      -m 512 \
      -drive file=test-disk.qcow2,format=qcow2 \
      -drive file=/dev/zvol/tank/vm-disk-1,format=raw \
      -cdrom alpine-virt-3.20.0-x86_64.iso \
      -boot d</code></li>
<li>
<p><strong>Verify inside the VM</strong>:</p>
<ul>
<li>Log in (user: <code>root</code>, no password).</li>
<li>Run <code>fdisk -l</code>.</li>
<li>You should see <code>/dev/vdb</code> (the 500MB Zvol) alongside <code>/dev/vda</code> (the QCOW2 disk)!</li>
</ul>
</li>
</ol>
</li>
</ol>
<hr />
<h2 id="lab-checkpoint">Lab Checkpoint</h2>
<h3 id="practical-skills-checklist">Practical Skills Checklist</h3>
<ul>
<li class="task-list-item"><input type="checkbox" disabled> Created <code>raw</code> and <code>qcow2</code> images using <code>qemu-img</code></li>
<li class="task-list-item"><input type="checkbox" disabled> Inspected image details (virtual vs disk size)</li>
<li class="task-list-item"><input type="checkbox" disabled> Converted and resized disk images via CLI</li>
<li class="task-list-item"><input type="checkbox" disabled> Created partitions using LVM inside a guest</li>
<li class="task-list-item"><input type="checkbox" disabled> Created an internal snapshot using <code>qemu-img snapshot</code></li>
<li class="task-list-item"><input type="checkbox" disabled> Performed a cold backup using file copy</li>
<li class="task-list-item"><input type="checkbox" disabled> Created a ZFS mirrored pool using file-backed storage</li>
<li class="task-list-item"><input type="checkbox" disabled> Demonstrated ZFS self-healing after data corruption</li>
<li class="task-list-item"><input type="checkbox" disabled> Created a ZFS Volume (Zvol) to act as a VM block device</li>
</ul>
<h3 id="theoretical-understanding-checklist">Theoretical Understanding Checklist</h3>
<ul>
<li class="task-list-item"><input type="checkbox" disabled> Explained the difference between <code>Virtual Size</code> and <code>Disk Size</code></li>
<li class="task-list-item"><input type="checkbox" disabled> Understood why <code>qcow2</code> supports snapshots but <code>raw</code> does not</li>
<li class="task-list-item"><input type="checkbox" disabled> Explained the function of LVM (PV, VG, LV)</li>
<li class="task-list-item"><input type="checkbox" disabled> Identified the risk of "Cold Backups" (Downtime)</li>
<li class="task-list-item"><input type="checkbox" disabled> Explained how ZFS differs from traditional RAID (Checksumming/CoW)</li>
<li class="task-list-item"><input type="checkbox" disabled> Differentiated between a ZFS Dataset (File System) and a Zvol (Block Device)</li>
</ul>
<h3 id="troubleshooting-scenarios">Troubleshooting Scenarios</h3>
<p><strong>Scenario 1</strong>: <code>qemu-img</code> shows disk size is 0 bytes, but virtual size is 100GB.<br />
<em>Explanation</em>: <code>[ _________________________________________________________________________ ]</code></p>
<p><strong>Scenario 2</strong>: You try to take a snapshot of a <code>raw</code> disk and get an error.<br />
<em>Solution</em>: <code>[ _________________________________________________________________________ ]</code></p>
<p><strong>Scenario 3</strong>: ZFS pool shows status "DEGRADED".<br />
<em>Action Required</em>: <code>[ _________________________________________________________________________ ]</code></p>
<hr />
<h2 id="lab-reflection">Lab Reflection</h2>
<ol>
<li>
<p><strong>Storage Layering</strong>: How does the KVM file (<code>.qcow2</code>) relate to the LVM (<code>/dev/vg/lv</code>) inside the guest?
    <code>[ _________________________________________________________________________ ]</code></p>
</li>
<li>
<p><strong>Format Choice</strong>: When would you use <code>raw</code> (Performance) vs <code>qcow2</code> (Features)?
    <code>[ _________________________________________________________________________ ]</code></p>
</li>
<li>
<p><strong>ZFS Concepts</strong>: KVM needs a Block Device. Does it use a ZFS Dataset or a Zvol? Why?
    <code>[ _________________________________________________________________________ ]</code></p>
</li>
<li>
<p><strong>ZFS vs Hardware RAID</strong>: Why is ZFS considered safer against "silent bit rot" than traditional RAID controller cards?
    <code>[ _________________________________________________________________________ ]</code>
    <code>[ _________________________________________________________________________ ]</code></p>
</li>
<li>
<p><strong>Next Concepts</strong>: What would you like to learn next (advanced networking, Kubernetes storage)?
    <code>[ _________________________________________________________________________ ]</code></p>
</li>
</ol>
<hr />
<p><a href="../Course_Index.html">← Back to Course Index</a></p>
    </article>
</main>

<!-- Footer -->
<footer class="text-center text-slate-500 dark:text-slate-400 text-sm pb-8">
</footer>

<!-- Progress Tracking -->
<script src="../js/course_logic.js"></script>

</body>
</html>
